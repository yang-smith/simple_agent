<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .chat-history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background-color: #f8f9fa;
            margin-bottom: 15px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
        }
        .user-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .agent-message {
            background-color: #f1f8e9;
            border-left: 4px solid #4caf50;
        }
        .tool-result {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            font-family: monospace;
            font-size: 0.9em;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        .system-info {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .warning {
            background-color: #fff8e1;
            border: 1px solid #ffc107;
            color: #f57c00;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.2em;
            color: #007bff;
        }
        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .input-area textarea {
            flex: 1;
            resize: vertical;
            min-height: 60px;
        }
        .send-button {
            height: 60px;
            padding: 0 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Agent System Test</h1>
        
        <div id="systemStatus" class="system-info" style="display: none;">
            âœ… Agentç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆ
        </div>
        
        <div id="initError" class="warning" style="display: none;">
            âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°
        </div>
        
        <div class="form-group">
            <label for="userToken">User Token (Required):</label>
            <input type="password" id="userToken" placeholder="Enter your gateway user token" value="sk-gw-7f8a9b2c4d6e1f3a5b7c9d2e4f6a8b1c">
        </div>
        
        <div class="form-group">
            <label for="model">Model:</label>
            <select id="model">
                <option value="anthropic/claude-4-sonnet-20250522">anthropic/claude-4-sonnet-20250522</option>
                <option value="google/gemini-2.5-pro" selected>google/gemini-2.5-pro</option>
                <option value="google/gemini-2.5-flash" selected>Google Gemini 2.5 Flash</option>
            </select>
        </div>

        <div class="form-group">
            <label for="maxIterations">Max Iterations:</label>
            <input type="number" id="maxIterations" min="1" max="10" value="3">
        </div>

        <div class="form-group">
            <label for="maxContextLength">Max Context Length:</label>
            <input type="number" id="maxContextLength" min="1000" max="16000" value="8000">
        </div>
    </div>

    <div class="container">
        <h2>ğŸ’¬ Chat Interface</h2>
        
        <div id="chatHistory" class="chat-history">
            <div class="message agent-message">
                <strong>Agent:</strong> ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æœç´¢ä¿¡æ¯ã€æŸ¥è¯¢è®°å¿†ï¼Œä»¥åŠå¤„ç†å„ç§ä»»åŠ¡ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
            </div>
        </div>
        
        <div id="agentStatus" class="system-info" style="display: none;">
            <div id="statusText">ğŸ¤– å°±ç»ª</div>
        </div>
        
        <div class="input-area">
            <textarea id="userInput" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." rows="3"></textarea>
            <button id="sendMessage" class="send-button">å‘é€</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button id="clearChat">æ¸…ç©ºå¯¹è¯</button>
            <button id="showStats">æ˜¾ç¤ºç»Ÿè®¡</button>
            <button id="testScenario1">æµ‹è¯•åœºæ™¯1: ç½‘ç»œæœç´¢</button>
            <button id="testScenario2">æµ‹è¯•åœºæ™¯2: è®°å¿†ç³»ç»Ÿ</button>
            <button id="testScenario3">æµ‹è¯•åœºæ™¯3: å¤šå·¥å…·è°ƒç”¨</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š Agent Statistics</h2>
        <div id="statsContainer" class="stats">
            <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>

    <script type="module">
        import { createAgent } from './src/core/agent.js';
        import { LLMClient } from './src/llm/llm-client.js';
        import { initializeTools } from './src/tools/index.js';
        
        let agent = null;
        let llmClient = null;
        
        // DOM å…ƒç´ 
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendMessage');
        const clearButton = document.getElementById('clearChat');
        const showStatsButton = document.getElementById('showStats');
        const systemStatus = document.getElementById('systemStatus');
        const agentStatus = document.getElementById('agentStatus');
        const statusText = document.getElementById('statusText');
        const initError = document.getElementById('initError');
        const statsContainer = document.getElementById('statsContainer');
        
        // çŠ¶æ€å›¾æ ‡æ˜ å°„
        const statusIcons = {
            'idle': 'ğŸ¤–',
            'processing': 'âš¡',
            'thinking': 'ğŸ¤”',
            'tool_calling': 'ğŸ”§',
            'error': 'âŒ'
        };
        
        // ç›‘å¬çŠ¶æ€å˜åŒ–
        window.addEventListener('agentStatusChange', (event) => {
            const { status, details } = event.detail;
            const icon = statusIcons[status] || 'ğŸ¤–';
            statusText.textContent = `${icon} ${details || status}`;
            agentStatus.style.display = 'block';
            
            // å¦‚æœæ˜¯é”™è¯¯çŠ¶æ€ï¼Œæ”¹å˜æ ·å¼
            if (status === 'error') {
                agentStatus.className = 'warning';
            } else {
                agentStatus.className = 'system-info';
            }
        });
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                console.log('ğŸš€ Initializing Agent System...');
                
                // åˆå§‹åŒ–å·¥å…·ç³»ç»Ÿ
                await initializeTools();
                console.log('âœ… Tools initialized');
                
                // åˆ›å»ºAgentå®ä¾‹
                const options = {
                    maxIterations: parseInt(document.getElementById('maxIterations').value),
                    maxContextLength: parseInt(document.getElementById('maxContextLength').value)
                };
                agent = createAgent(options);
                console.log('âœ… Agent created');
                
                // åˆ›å»ºLLMå®¢æˆ·ç«¯
                createLLMClient();
                console.log('âœ… LLM client ready');
                
                // è®¾ç½®åˆå§‹çŠ¶æ€
                if (agent) {
                    agent.setGlobalStatus('idle', 'å°±ç»ª');
                }
                
                systemStatus.style.display = 'block';
                console.log('ğŸ‰ Agent System fully initialized!');
                
            } catch (error) {
                console.error('âŒ System initialization failed:', error);
                initError.style.display = 'block';
                initError.innerHTML = `âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`;
            }
        }
        
        // åˆ›å»ºLLMå®¢æˆ·ç«¯
        function createLLMClient() {
            const userToken = document.getElementById('userToken').value;
            const model = document.getElementById('model').value;
            
            if (!userToken.trim()) {
                throw new Error('User token is required');
            }
            
            llmClient = new LLMClient({
                userToken: userToken,
                model: model
            });
        }
        
        // LLMè°ƒç”¨å‡½æ•°
        async function llmCall(context) {
            if (!llmClient) {
                createLLMClient();
            }
            
            try {
                console.log('ğŸ” Sending messages to LLM:', context);
                const response = await llmClient.chat({
                    messages: context,
                    temperature: 0.7,
                    maxTokens: 2000
                });
                console.log('ğŸ¤– LLM Response:', response);
                return response;
            } catch (error) {
                throw new Error(`LLMè°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å²
        function addMessageToHistory(content, type = 'user', isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            if (isError) messageDiv.classList.add('error');
            
            const typeLabel = {
                'user': 'ç”¨æˆ·',
                'agent': 'Agent',
                'tool': 'å·¥å…·æ‰§è¡Œ',
                'system': 'ç³»ç»Ÿ'
            }[type] || type;
            
            if (type === 'tool') {
                messageDiv.innerHTML = `<strong>${typeLabel}:</strong><br><pre>${content}</pre>`;
            } else {
                messageDiv.innerHTML = `<strong>${typeLabel}:</strong> ${content}`;
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            if (!agent) {
                addMessageToHistory('ç³»ç»Ÿå°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè¯·ç­‰å¾…...', 'system', true);
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessageToHistory(message, 'user');
            userInput.value = '';
            sendButton.disabled = true;
            
            try {
                // ä½¿ç”¨Agentå¤„ç†æ¶ˆæ¯
                const response = await agent.processSingleMessage(message, llmCall);
                
                // æ˜¾ç¤ºAgentå›å¤
                addMessageToHistory(response, 'agent');
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats();
                
            } catch (error) {
                console.error('Message processing error:', error);
                addMessageToHistory(`å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: ${error.message}`, 'system', true);
            } finally {
                sendButton.disabled = false;
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (!agent) return;
            
            const stats = agent.getStats();
            const state = agent.getCurrentState();
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">æ€»äº‹ä»¶æ•°</div>
                    <div class="stat-value">${stats.totalEvents}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ç”¨æˆ·æ¶ˆæ¯</div>
                    <div class="stat-value">${stats.eventTypes.user_message || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Agentå›å¤</div>
                    <div class="stat-value">${stats.eventTypes.agent_message || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">å·¥å…·è°ƒç”¨</div>
                    <div class="stat-value">${stats.eventTypes.tool_result || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">é¦–æ¬¡äº‹ä»¶</div>
                    <div class="stat-value">${stats.firstEvent ? new Date(stats.firstEvent).toLocaleTimeString() : 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">æœ€æ–°äº‹ä»¶</div>
                    <div class="stat-value">${stats.lastEvent ? new Date(stats.lastEvent).toLocaleTimeString() : 'N/A'}</div>
                </div>
            `;
        }
        
        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (agent) {
                agent.clearState();
            }
            chatHistory.innerHTML = `
                <div class="message agent-message">
                    <strong>Agent:</strong> å¯¹è¯å·²æ¸…ç©ºã€‚æˆ‘ä»¬å¯ä»¥é‡æ–°å¼€å§‹ï¼
                </div>
            `;
            updateStats();
        }
        
        // æµ‹è¯•åœºæ™¯
        const testScenarios = {
            scenario1: "è¯·å¸®æˆ‘æœç´¢ä¸€ä¸‹ä»Šå¤©çš„å¤©æ°”æƒ…å†µ",
            scenario2: "è¯·è®°ä½æˆ‘çš„åå­—æ˜¯å¼ ä¸‰ï¼Œæˆ‘å–œæ¬¢ç¼–ç¨‹å’Œé˜…è¯»",
            scenario3: "è¯·æœç´¢æœ€æ–°çš„AIæŠ€æœ¯å‘å±•ï¼Œå¹¶æŠŠé‡è¦ä¿¡æ¯ä¿å­˜åˆ°è®°å¿†ä¸­"
        };
        
        async function runTestScenario(scenarioKey) {
            const message = testScenarios[scenarioKey];
            if (!message) return;
            
            userInput.value = message;
            await sendMessage();
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        sendButton.addEventListener('click', sendMessage);
        clearButton.addEventListener('click', clearChat);
        showStatsButton.addEventListener('click', updateStats);
        
        document.getElementById('testScenario1').addEventListener('click', () => runTestScenario('scenario1'));
        document.getElementById('testScenario2').addEventListener('click', () => runTestScenario('scenario2'));
        document.getElementById('testScenario3').addEventListener('click', () => runTestScenario('scenario3'));
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // æ¨¡å‹æˆ–é…ç½®æ”¹å˜æ—¶é‡æ–°åˆ›å»ºLLMå®¢æˆ·ç«¯
        document.getElementById('model').addEventListener('change', () => {
            if (llmClient) {
                createLLMClient();
                console.log('ğŸ”„ LLM client updated');
            }
        });
        
        document.getElementById('userToken').addEventListener('change', () => {
            if (llmClient) {
                createLLMClient();
                console.log('ğŸ”„ LLM client updated');
            }
        });

        // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºçŠ¶æ€
        function showInitialStatus() {
            const savedStatus = localStorage.getItem('agent_status');
            if (savedStatus) {
                try {
                    const statusData = JSON.parse(savedStatus);
                    window.dispatchEvent(new CustomEvent('agentStatusChange', { detail: statusData }));
                } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', () => {
            showInitialStatus();
            initializeSystem();
        });
        
        // åˆå§‹åŒ–ç»Ÿè®¡æ˜¾ç¤º
        updateStats();
    </script>
</body>
</html> 