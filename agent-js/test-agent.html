<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* é…ç½®åŒºåŸŸæ ·å¼ */
        .config-section {
            margin-bottom: 15px;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 5px 0;
        }
        
        .config-header h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.8em;
        }
        
        .toggle-icon {
            font-size: 1.2em;
            color: #7f8c8d;
            transition: transform 0.3s ease;
        }
        
        .toggle-icon.rotated {
            transform: rotate(-90deg);
        }
        
        .config-panel {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 500px;
            opacity: 1;
        }
        
        .config-panel.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        /* å¯¹è¯å®¹å™¨æ ·å¼ */
        .chat-container {
            flex: 1;
            min-height: 500px;
        }
        
        .chat-container h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            text-align: center;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .chat-history {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
            margin-bottom: 20px;
            scroll-behavior: smooth;
        }
        
        .message {
            display: flex;
            margin-bottom: 16px;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .user-message .message-avatar {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            margin-right: 0;
            margin-left: 12px;
        }
        
        .user-message .message-content {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #2196f3;
        }
        
        .agent-message .message-content {
            background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%);
            border: 1px solid #4caf50;
        }
        
        .tool-result .message-content {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 1px solid #ff9800;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }
        
        .error .message-content {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .status-indicator {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .input-section {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e1e8ed;
        }
        
        .input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 15px;
        }
        
        .input-area textarea {
            flex: 1;
            resize: vertical;
            min-height: 50px;
            max-height: 150px;
        }
        
        .send-button {
            height: 50px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .stats-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .stat-value {
            font-size: 1.8em;
            color: #667eea;
            font-weight: bold;
        }
        
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .ctrl-btn {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .states-display {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        /* States ç›¸å…³æ ·å¼ */
        .states-formatted {
            padding: 15px;
        }
        
        .state-item {
            background: white;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }
        
        .state-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .state-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .state-type {
            font-weight: 600;
            color: #495057;
        }
        
        .state-time {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .state-content {
            padding: 16px;
        }
        
        .message-content-state {
            line-height: 1.6;
            color: #495057;
        }
        
        .tool-content {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        
        .error-content {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            padding: 12px;
            border-radius: 6px;
            color: #c62828;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }
        
        .generic-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
        
        .states-raw {
            padding: 20px;
        }
        
        .states-raw pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.6;
            margin: 0;
        }
        
        .states-raw code {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .input-area {
                flex-direction: column;
                gap: 10px;
            }
            
            .send-button {
                width: 100%;
                height: 45px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .control-panel {
                justify-content: center;
            }
        }

        /* è®°å¿†ç›¸å…³æ ·å¼ */
        .memory-container {
            margin-top: 20px;
        }
        
        .memory-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .memory-section {
            margin-bottom: 25px;
        }
        
        .memory-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .memory-meta {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }
        
        .long-term-memory pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container config-section">
        <div class="config-header" id="configHeader">
            <h1>ğŸ¤– Agent System Test</h1>
            <span id="configToggle" class="toggle-icon">â–¼</span>
        </div>
        
        <div id="configPanel" class="config-panel collapsed">
            <div id="systemStatus" class="system-info" style="display: none;">
                âœ… Agentç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆ
            </div>
            
            <div id="initError" class="warning" style="display: none;">
                âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°
            </div>
            
            <div class="form-group">
                <label for="userToken">User Token (Required):</label>
                <input type="password" id="userToken" placeholder="Enter your gateway user token" value="sk-gw-7f8a9b2c4d6e1f3a5b7c9d2e4f6a8b1c">
            </div>
            
            <div class="form-group">
                <label for="model">Model:</label>
                <select id="model">
                    <option value="anthropic/claude-4-sonnet-20250522">anthropic/claude-4-sonnet-20250522</option>
                    <option value="google/gemini-2.5-pro">google/gemini-2.5-pro</option>
                    <option value="google/gemini-2.5-flash" selected>Google Gemini 2.5 Flash</option>
                </select>
            </div>

            <div class="form-group">
                <label for="maxIterations">Max Iterations:</label>
                <input type="number" id="maxIterations" min="1" max="10" value="3">
            </div>

            <div class="form-group">
                <label for="maxContextLength">Max Context Length:</label>
                <input type="number" id="maxContextLength" min="1000" max="16000" value="8000">
            </div>
        </div>
    </div>

    <div class="container chat-container">
        <h2>ğŸ’¬ AIåŠ©æ‰‹å¯¹è¯</h2>
        
        <div id="chatHistory" class="chat-history">
            <div class="message agent-message">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <strong>AIåŠ©æ‰‹:</strong> ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æœç´¢ä¿¡æ¯ã€æŸ¥è¯¢è®°å¿†ï¼Œä»¥åŠå¤„ç†å„ç§ä»»åŠ¡ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                </div>
            </div>
        </div>
        
        <div id="agentStatus" class="status-indicator" style="display: none;">
            <div id="statusText">ğŸ¤– å°±ç»ª</div>
        </div>
        
        <div class="input-section">
            <div class="input-area">
                <textarea id="userInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„æ¶ˆæ¯..." rows="2"></textarea>
                <button id="sendMessage" class="send-button">
                    <span class="button-text">å‘é€</span>
                    <span class="button-icon">ğŸ“¤</span>
                </button>
            </div>
            
            <div class="action-buttons">
                <button id="clearChat" class="action-btn clear-btn">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
                <button id="showStats" class="action-btn stats-btn">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</button>
            </div>
        </div>
    </div>

    <div class="container stats-container" id="statsSection">
        <h3>ğŸ“Š å¯¹è¯ç»Ÿè®¡</h3>
        <div id="statsContainer" class="stats">
            <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>

    <div class="container states-container" id="statesSection">
        <h3>ğŸ” ç³»ç»ŸçŠ¶æ€</h3>
        <div class="control-panel">
            <button id="refreshStates" class="ctrl-btn">ğŸ”„ åˆ·æ–°</button>
            <button id="toggleStatesView" class="ctrl-btn">ğŸ‘ï¸ åˆ‡æ¢è§†å›¾</button>
            <button id="exportStates" class="ctrl-btn">ğŸ“¤ å¯¼å‡º</button>
            <button id="importStates" class="ctrl-btn">ğŸ“¥ å¯¼å…¥</button>
            <button id="showMemoryStats" class="ctrl-btn">ğŸ§  è®°å¿†ç»Ÿè®¡</button>
            <button id="clearMemories" class="ctrl-btn">ğŸ—‘ï¸ æ¸…ç©ºè®°å¿†</button>
        </div>
        <div id="statesContainer" class="states-display">
            <!-- çŠ¶æ€ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>

    <!-- æ–°å¢è®°å¿†çŠ¶æ€å®¹å™¨ -->
    <div class="container memory-container" id="memorySection" style="display: none;">
        <h3>ğŸ§  è®°å¿†ç³»ç»ŸçŠ¶æ€</h3>
        <div class="control-panel">
            <button id="refreshMemory" class="ctrl-btn">ğŸ”„ åˆ·æ–°è®°å¿†</button>
            <button id="toggleMemoryView" class="ctrl-btn">ğŸ‘ï¸ åˆ‡æ¢è®°å¿†è§†å›¾</button>
            <button id="exportMemory" class="ctrl-btn">ğŸ“¤ å¯¼å‡ºè®°å¿†</button>
        </div>
        <div id="memoryContainer" class="states-display">
            <!-- è®°å¿†ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>

    <script type="module">
        import { createAgent } from './src/core/agent.js';
        import { LLMClient } from './src/llm/llm-client.js';
        import { initializeTools } from './src/tools/index.js';
        
        // åˆ‡æ¢é…ç½®é¢æ¿æ˜¾ç¤º/éšè— - ç§»åˆ°å‰é¢å®šä¹‰
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            const toggle = document.getElementById('configToggle');
            
            panel.classList.toggle('collapsed');
            toggle.classList.toggle('rotated');
        }

        // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºçŠ¶æ€
        function showInitialStatus() {
            const savedStatus = localStorage.getItem('agent_status');
            if (savedStatus) {
                try {
                    const statusData = JSON.parse(savedStatus);
                    window.dispatchEvent(new CustomEvent('agentStatusChange', { detail: statusData }));
                } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
            }
        }
        
        let agent = null;
        let llmClient = null;
        let statesViewMode = 'formatted'; // 'formatted' or 'raw'
        let memoryViewMode = 'formatted'; // 'formatted' or 'raw'
        
        // DOM å…ƒç´ 
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendMessage');
        const clearButton = document.getElementById('clearChat');
        const showStatsButton = document.getElementById('showStats');
        const systemStatus = document.getElementById('systemStatus');
        const agentStatus = document.getElementById('agentStatus');
        const statusText = document.getElementById('statusText');
        const initError = document.getElementById('initError');
        const statsContainer = document.getElementById('statsContainer');
        const statesContainer = document.getElementById('statesContainer');
        const refreshStatesButton = document.getElementById('refreshStates');
        const toggleStatesViewButton = document.getElementById('toggleStatesView');
        const exportStatesButton = document.getElementById('exportStates');
        const importStatesButton = document.getElementById('importStates');
        
        // çŠ¶æ€å›¾æ ‡æ˜ å°„
        const statusIcons = {
            'idle': 'ğŸ¤–',
            'processing': 'âš¡',
            'thinking': 'ğŸ¤”',
            'tool_calling': 'ğŸ”§',
            'error': 'âŒ'
        };
        
        // ç›‘å¬çŠ¶æ€å˜åŒ–
        window.addEventListener('agentStatusChange', (event) => {
            const { status, details } = event.detail;
            const icon = statusIcons[status] || 'ğŸ¤–';
            statusText.textContent = `${icon} ${details || status}`;
            agentStatus.style.display = 'block';
            
            // å¦‚æœæ˜¯é”™è¯¯çŠ¶æ€ï¼Œæ”¹å˜æ ·å¼
            if (status === 'error') {
                agentStatus.className = 'warning';
            } else {
                agentStatus.className = 'system-info';
            }
        });
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                console.log('ğŸš€ Initializing Agent System...');
                
                // åˆå§‹åŒ–å·¥å…·ç³»ç»Ÿ
                await initializeTools();
                console.log('âœ… Tools initialized');
                
                // åˆ›å»ºAgentå®ä¾‹
                const options = {
                    maxIterations: parseInt(document.getElementById('maxIterations').value),
                    maxContextLength: parseInt(document.getElementById('maxContextLength').value)
                };
                agent = createAgent(options);
                console.log('âœ… Agent created');
                
                // æ¢å¤ä¿å­˜çš„çŠ¶æ€
                restoreAgentState();
                
                // åˆ›å»ºLLMå®¢æˆ·ç«¯
                createLLMClient();
                console.log('âœ… LLM client ready');
                
                // è®¾ç½®åˆå§‹çŠ¶æ€
                if (agent) {
                    agent.setGlobalStatus('idle', 'å°±ç»ª');
                }
                
                systemStatus.style.display = 'block';
                console.log('ğŸ‰ Agent System fully initialized!');
                
            } catch (error) {
                console.error('âŒ System initialization failed:', error);
                initError.style.display = 'block';
                initError.innerHTML = `âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`;
            }
        }
        
        // åˆ›å»ºLLMå®¢æˆ·ç«¯
        function createLLMClient() {
            const userToken = document.getElementById('userToken').value;
            const model = document.getElementById('model').value;
            
            if (!userToken.trim()) {
                throw new Error('User token is required');
            }
            
            llmClient = new LLMClient({
                userToken: userToken,
                model: model
            });
        }
        
        // LLMè°ƒç”¨å‡½æ•° - æ”¹ä¸ºæµå¼ç‰ˆæœ¬
        async function llmCall(context) {
            if (!llmClient) {
                createLLMClient();
            }
            
            try {
                console.log('ğŸ” Sending messages to LLM:', context);
                
                // ä½¿ç”¨æµå¼æ¥å£
                let fullResponse = '';
                const responseGenerator = llmClient.chatStream({
                    messages: context,
                    temperature: 0.3,
                    maxTokens: 8000
                });
                
                for await (const chunk of responseGenerator) {
                    fullResponse += chunk;
                }
                
                console.log('ğŸ¤– LLM Response:', fullResponse);
                return fullResponse;
            } catch (error) {
                throw new Error(`LLMè°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }
        
        // ç®€å•çš„markdownè½¬HTMLå‡½æ•°
        function markdownToHtml(text) {
            return text
                // ä»£ç å— ```code```
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>')
                // è¡Œå†…ä»£ç  `code`
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // ç²—ä½“ **text**
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // æ–œä½“ *text*
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // é“¾æ¥ [text](url)
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                // æ¢è¡Œ
                .replace(/\n/g, '<br>');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å² - ä¿®æ”¹ä»¥æ”¯æŒmarkdown
        function addMessageToHistory(content, type = 'user', isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            if (isError) messageDiv.classList.add('error');
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const typeConfig = {
                'user': { icon: 'ğŸ‘¤', label: 'ä½ ' },
                'agent': { icon: 'ğŸ¤–', label: 'AIåŠ©æ‰‹' },
                'tool': { icon: 'ğŸ”§', label: 'å·¥å…·' },
                'system': { icon: 'âš™ï¸', label: 'ç³»ç»Ÿ' }
            };
            
            const config = typeConfig[type] || { icon: 'ğŸ“', label: type };
            avatar.textContent = config.icon;
            
            if (type === 'tool') {
                messageContent.innerHTML = `<strong>${config.label}:</strong><br><pre>${content}</pre>`;
            } else if (type === 'agent') {
                // AIæ¶ˆæ¯æ”¯æŒmarkdown
                const htmlContent = markdownToHtml(content);
                messageContent.innerHTML = `<strong>${config.label}:</strong> <div class="message-text">${htmlContent}</div>`;
            } else {
                messageContent.innerHTML = `<strong>${config.label}:</strong> ${content}`;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ - ç®€åŒ–ç‰ˆæœ¬
        function updateStats() {
            if (!agent) return;
            
            const stats = agent.getStats();
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">æ€»å¯¹è¯è½®æ¬¡</div>
                    <div class="stat-value">${stats.eventTypes.user_message || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">å·¥å…·è°ƒç”¨æ¬¡æ•°</div>
                    <div class="stat-value">${stats.eventTypes.tool_result || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ä¼šè¯æ—¶é•¿</div>
                    <div class="stat-value">${getSessionDuration(stats)}</div>
                </div>
            `;
        }
        
        // è®¡ç®—ä¼šè¯æ—¶é•¿
        function getSessionDuration(stats) {
            if (!stats.firstEvent || !stats.lastEvent) return '0åˆ†é’Ÿ';
            
            const duration = new Date(stats.lastEvent) - new Date(stats.firstEvent);
            const minutes = Math.floor(duration / (1000 * 60));
            
            if (minutes < 1) return '< 1åˆ†é’Ÿ';
            if (minutes < 60) return `${minutes}åˆ†é’Ÿ`;
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ`;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStates() {
            if (!agent) {
                statesContainer.innerHTML = '<div class="warning">Agentæœªåˆå§‹åŒ–</div>';
                return;
            }
            
            const states = agent.getCurrentState();
            
            if (!states || states.length === 0) {
                statesContainer.innerHTML = '<div class="system-info">æš‚æ— çŠ¶æ€æ•°æ®</div>';
                return;
            }
            
            if (statesViewMode === 'raw') {
                // åŸå§‹JSONè§†å›¾
                statesContainer.innerHTML = `
                    <div class="states-raw">
                        <pre><code>${JSON.stringify(states, null, 2)}</code></pre>
                    </div>
                `;
            } else {
                // æ ¼å¼åŒ–è§†å›¾
                const formattedStates = states.map((state, index) => {
                    const timestamp = new Date(state.timestamp).toLocaleString('zh-CN');
                    const typeIcon = getStateTypeIcon(state.type);
                    
                    return `
                        <div class="state-item" data-index="${index}">
                            <div class="state-header">
                                <span class="state-type">${typeIcon} ${state.type}</span>
                                <span class="state-time">${timestamp}</span>
                            </div>
                            <div class="state-content">
                                ${formatStateContent(state)}
                            </div>
                        </div>
                    `;
                }).join('');
                
                statesContainer.innerHTML = `
                    <div class="states-formatted">
                        ${formattedStates}
                    </div>
                `;
            }
        }
        
        // è·å–çŠ¶æ€ç±»å‹å›¾æ ‡
        function getStateTypeIcon(type) {
            const icons = {
                'user_message': 'ğŸ‘¤',
                'agent_message': 'ğŸ¤–',
                'tool_result': 'ğŸ”§',
                'tool_call': 'âš™ï¸',
                'error': 'âŒ',
                'system': 'âš¡'
            };
            return icons[type] || 'ğŸ“';
        }
        
        // æ ¼å¼åŒ–çŠ¶æ€å†…å®¹
        function formatStateContent(state) {
            const data = state.data || {};
            
            switch (state.type) {
                case 'user_message':
                case 'agent_message':
                    return `<div class="message-content-state">${data.content || 'N/A'}</div>`;
                    
                case 'tool_result':
                    const results = data.results || [];
                    if (results.length === 0) return '<div class="tool-content">æ— å·¥å…·ç»“æœ</div>';
                    
                    return results.map(result => `
                        <div class="tool-content">
                            <strong>å·¥å…·:</strong> ${result.tool_name || 'Unknown'}<br>
                            <strong>çŠ¶æ€:</strong> ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}<br>
                            ${result.success ? 
                                `<strong>ç»“æœ:</strong> ${JSON.stringify(result.result || {}, null, 2)}` : 
                                `<strong>é”™è¯¯:</strong> ${result.error || 'Unknown error'}`
                            }
                        </div>
                    `).join('');
                    
                case 'tool_call':
                    return `
                        <div class="tool-content">
                            <strong>å·¥å…·å:</strong> ${data.toolName || 'N/A'}<br>
                            <strong>å‚æ•°:</strong> ${JSON.stringify(data.parameters || {}, null, 2)}
                        </div>
                    `;
                    
                case 'error':
                    return `
                        <div class="error-content">
                            <strong>é”™è¯¯:</strong> ${data.error || 'N/A'}<br>
                            ${data.stack ? `<strong>å †æ ˆ:</strong><pre>${data.stack}</pre>` : ''}
                        </div>
                    `;
                    
                default:
                    return `<div class="generic-content">${JSON.stringify(data, null, 2)}</div>`;
            }
        }
        
        // åˆ‡æ¢çŠ¶æ€è§†å›¾æ¨¡å¼
        function toggleStatesView() {
            statesViewMode = statesViewMode === 'formatted' ? 'raw' : 'formatted';
            toggleStatesViewButton.textContent = statesViewMode === 'formatted' ? 'åˆ‡æ¢åˆ°åŸå§‹è§†å›¾' : 'åˆ‡æ¢åˆ°æ ¼å¼åŒ–è§†å›¾';
            updateStates();
        }
        
        // æµå¼å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            if (!agent) {
                addMessageToHistory('ç³»ç»Ÿå°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè¯·ç­‰å¾…...', 'system', true);
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessageToHistory(message, 'user');
            userInput.value = '';
            sendButton.disabled = true;
            
            // åˆ›å»ºAIå›å¤çš„æ¶ˆæ¯å®¹å™¨
            const aiMessageDiv = createMessageContainer('agent');
            const messageContent = aiMessageDiv.querySelector('.message-content');
            
            try {
                // ä½¿ç”¨Agentå¤„ç†æ¶ˆæ¯ - æµå¼ç‰ˆæœ¬
                await processSingleMessageStream(message, messageContent);
                
                // ä¿å­˜çŠ¶æ€åˆ°localStorage
                saveAgentState();
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’ŒçŠ¶æ€
                updateStats();
                updateStates();
                
            } catch (error) {
                console.error('Message processing error:', error);
                messageContent.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> <span class="error-text">å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: ${error.message}</span>`;
            } finally {
                sendButton.disabled = false;
            }
        }

        // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
        function createMessageContainer(type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const typeConfig = {
                'user': { icon: 'ğŸ‘¤', label: 'ä½ ' },
                'agent': { icon: 'ğŸ¤–', label: 'AIåŠ©æ‰‹' },
                'tool': { icon: 'ğŸ”§', label: 'å·¥å…·' },
                'system': { icon: 'âš™ï¸', label: 'ç³»ç»Ÿ' }
            };
            
            const config = typeConfig[type] || { icon: 'ğŸ“', label: type };
            avatar.textContent = config.icon;
            
            // åˆå§‹åŒ–å†…å®¹
            messageContent.innerHTML = `<strong>${config.label}:</strong> <span class="typing-indicator">æ­£åœ¨è¾“å…¥...</span>`;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            return messageDiv;
        }

        // æµå¼å¤„ç†å•æ¡æ¶ˆæ¯ - ä¿®æ”¹æ˜¾ç¤ºéƒ¨åˆ†
        async function processSingleMessageStream(message, messageContentElement) {
            try {
                agent.setGlobalStatus('processing', 'æ­£åœ¨å¤„ç†ç”¨æˆ·æ¶ˆæ¯...');
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°çŠ¶æ€
                agent.addUserMessage(message);

                // æ£€æŸ¥å¹¶æ¸…ç†ä¸Šä¸‹æ–‡ï¼ˆæ–°å¢ï¼‰
                await agent.checkAndCleanupContext();

                agent.setGlobalStatus('thinking', 'æ­£åœ¨æ€è€ƒå›å¤...');
                
                // ç”Ÿæˆä¸Šä¸‹æ–‡
                const currentState = agent.getCurrentState();
                const { createContextBuilder } = await import('./src/core/context.js');
                const maxContextLength = parseInt(document.getElementById('maxContextLength').value) || 8000;
                const contextBuilder = createContextBuilder({ maxContextLength });
                const context = await contextBuilder.createContextFromState(currentState);
                
                // æµå¼è°ƒç”¨LLM
                let fullResponse = '';
                let displayText = '';
                
                if (!llmClient) {
                    createLLMClient();
                }
                
                const responseGenerator = llmClient.chatStream({
                    messages: context,
                    temperature: 0.3,
                    maxTokens: 8000
                });
                
                // æµå¼æ›´æ–°æ˜¾ç¤º
                for await (const chunk of responseGenerator) {
                    fullResponse += chunk;
                    displayText += chunk;
                    
                    // å®æ—¶æ›´æ–°æ¶ˆæ¯å†…å®¹ - æ”¯æŒmarkdown
                    const htmlContent = markdownToHtml(displayText);
                    messageContentElement.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> <div class="message-text">${htmlContent}<span class="cursor">|</span></div>`;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    
                    // æ·»åŠ å°å»¶è¿Ÿä»¥è·å¾—æ›´å¥½çš„è§†è§‰æ•ˆæœ
                    await new Promise(resolve => setTimeout(resolve, 20));
                }
                
                // ç§»é™¤å…‰æ ‡
                const htmlContent = markdownToHtml(displayText);
                messageContentElement.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> <div class="message-text">${htmlContent}</div>`;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
                let toolResults;
                try {
                    if (fullResponse.includes('<function_calls>')) {
                        agent.setGlobalStatus('tool_calling', 'æ­£åœ¨è°ƒç”¨å·¥å…·...');
                        
                        const { parseAndExecuteFunctionCalls } = await import('./src/tools/index.js');
                        toolResults = await parseAndExecuteFunctionCalls(fullResponse);
                        
                        if (toolResults && toolResults.length > 0) {
                            agent.setGlobalStatus('thinking', 'æ­£åœ¨å¤„ç†å·¥å…·ç»“æœ...');
                        }
                    }
                } catch (error) {
                    console.error('Tool execution failed:', error);
                    toolResults = [];
                }
                
                if (toolResults && toolResults.length > 0) {
                    // æ‰§è¡Œå·¥å…·è°ƒç”¨
                    agent.addToolResult(toolResults);
                    
                    // æ˜¾ç¤ºå·¥å…·æ‰§è¡ŒæŒ‡ç¤º
                    const htmlContent = markdownToHtml(displayText);
                    messageContentElement.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> <div class="message-text">${htmlContent}</div><small class="tool-indicator">ğŸ”§ æ­£åœ¨æ•´ç†å·¥å…·æ‰§è¡Œç»“æœ...</small>`;
                    
                    // å†æ¬¡è°ƒç”¨LLMè·å–æœ€ç»ˆå›å¤
                    const updatedState = agent.getCurrentState();
                    const updatedContext = await contextBuilder.createContextFromState(updatedState);
                    
                    const finalResponseGenerator = llmClient.chatStream({
                        messages: updatedContext,
                        temperature: 0.3,
                        maxTokens: 8000
                    });
                    
                    let finalResponse = '';
                    let finalDisplayText = displayText + '\n\n';
                    
                    // æµå¼æ˜¾ç¤ºæœ€ç»ˆå›å¤
                    for await (const chunk of finalResponseGenerator) {
                        finalResponse += chunk;
                        finalDisplayText += chunk;
                        
                        const finalHtmlContent = markdownToHtml(finalDisplayText);
                        messageContentElement.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> <div class="message-text">${finalHtmlContent}<span class="cursor">|</span></div>`;
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                        
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                    
                    // æœ€ç»ˆæ˜¾ç¤º
                    const finalHtmlContent = markdownToHtml(finalDisplayText);
                    messageContentElement.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> <div class="message-text">${finalHtmlContent}</div>`;
                    agent.addAgentMessage(finalResponse);
                } else {
                    // ç›´æ¥å›å¤
                    agent.addAgentMessage(fullResponse);
                }
                
                agent.setGlobalStatus('idle', 'å°±ç»ª');
                
            } catch (error) {
                agent.setGlobalStatus('error', `å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: ${error.message}`);
                throw error;
            }
        }
        
        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (agent) {
                agent.clearState();
            }
            
            // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
            clearSavedState();
            
            chatHistory.innerHTML = `
                <div class="message agent-message">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <strong>AIåŠ©æ‰‹:</strong> å¯¹è¯å·²æ¸…ç©ºã€‚æˆ‘ä»¬å¯ä»¥é‡æ–°å¼€å§‹ï¼
                    </div>
                </div>
            `;
            updateStats();
            updateStates();
        }
        
        // ä¿å­˜çŠ¶æ€åˆ°localStorage
        function saveAgentState() {
            if (!agent) return;
            
            const state = agent.getCurrentState();
            try {
                localStorage.setItem('agent_conversation_state', JSON.stringify({
                    timestamp: new Date().toISOString(),
                    events: state
                }));
                console.log('ğŸ’¾ çŠ¶æ€å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (error) {
                console.warn('ä¿å­˜çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // ä»localStorageæ¢å¤çŠ¶æ€
        function restoreAgentState() {
            if (!agent) return;
            
            try {
                const savedData = localStorage.getItem('agent_conversation_state');
                if (savedData) {
                    const { timestamp, events } = JSON.parse(savedData);
                    
                    if (events && events.length > 0) {
                        // æ¢å¤æ¯ä¸ªäº‹ä»¶åˆ°state manager
                        events.forEach(event => {
                            // ç›´æ¥ä½¿ç”¨agentçš„å†…éƒ¨çŠ¶æ€ç®¡ç†å™¨æ·»åŠ äº‹ä»¶
                            const stateManager = agent.getCurrentState ? agent : null;
                            if (stateManager) {
                                // é€šè¿‡è°ƒç”¨ç›¸åº”çš„æ·»åŠ æ–¹æ³•æ¥æ¢å¤çŠ¶æ€
                                switch (event.type) {
                                    case 'user_message':
                                        agent.addUserMessage(event.data.content);
                                        break;
                                    case 'agent_message':
                                        agent.addAgentMessage(event.data.content);
                                        break;
                                    case 'tool_result':
                                        agent.addToolResult(event.data.results);
                                        break;
                                }
                            }
                        });
                        
                        // æ¢å¤èŠå¤©å†å²æ˜¾ç¤º
                        restoreChatHistory(events);
                        
                        console.log(`ğŸ”„ å·²æ¢å¤ ${events.length} ä¸ªå†å²äº‹ä»¶ (ä¿å­˜äº ${new Date(timestamp).toLocaleString()})`);
                        
                        // æ›´æ–°æ˜¾ç¤º
                        updateStats();
                        updateStates();
                    }
                }
            } catch (error) {
                console.warn('æ¢å¤çŠ¶æ€å¤±è´¥:', error);
                // å¦‚æœæ¢å¤å¤±è´¥ï¼Œæ¸…é™¤æŸåçš„æ•°æ®
                localStorage.removeItem('agent_conversation_state');
            }
        }
        
        // æ¢å¤èŠå¤©å†å²æ˜¾ç¤º - æ›´æ–°ç‰ˆæœ¬
        function restoreChatHistory(events) {
            // æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„å†å²
            chatHistory.innerHTML = '';
            
            events.forEach(event => {
                switch (event.type) {
                    case 'user_message':
                        addMessageToHistory(event.data.content, 'user');
                        break;
                    case 'agent_message':
                        addMessageToHistory(event.data.content, 'agent');
                        break;
                    case 'tool_result':
                        // å¯é€‰ï¼šæ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ
                        const results = event.data.results || [];
                        if (results.length > 0) {
                            const toolSummary = results.map(r => 
                                `${r.tool_name}: ${r.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`
                            ).join(', ');
                            addMessageToHistory(`å·¥å…·æ‰§è¡Œ: ${toolSummary}`, 'tool');
                        }
                        break;
                }
            });
            
            // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            if (events.length === 0) {
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'message agent-message';
                welcomeDiv.innerHTML = `
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <strong>AIåŠ©æ‰‹:</strong> ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æœç´¢ä¿¡æ¯ã€æŸ¥è¯¢è®°å¿†ï¼Œä»¥åŠå¤„ç†å„ç§ä»»åŠ¡ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                    </div>
                `;
                chatHistory.appendChild(welcomeDiv);
            }
        }
        
        // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
        function clearSavedState() {
            try {
                localStorage.removeItem('agent_conversation_state');
                console.log('ğŸ—‘ï¸ å·²æ¸…é™¤ä¿å­˜çš„å¯¹è¯çŠ¶æ€');
            } catch (error) {
                console.warn('æ¸…é™¤ä¿å­˜çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // å¯¼å‡ºçŠ¶æ€åˆ°æ–‡ä»¶
        function exportStates() {
            if (!agent) {
                alert('Agentæœªåˆå§‹åŒ–');
                return;
            }
            
            const state = agent.getCurrentState();
            const exportData = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                events: state
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `agent-state-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ğŸ“¤ çŠ¶æ€å·²å¯¼å‡ºåˆ°æ–‡ä»¶');
        }
        
        // å¯¼å…¥çŠ¶æ€ä»æ–‡ä»¶
        function importStates() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    if (importData.events && Array.isArray(importData.events)) {
                        // ç¡®è®¤å¯¼å…¥
                        const confirmed = confirm(
                            `ç¡®å®šè¦å¯¼å…¥ ${importData.events.length} ä¸ªäº‹ä»¶å—ï¼Ÿ\n` +
                            `å¯¼å…¥æ—¶é—´: ${new Date(importData.timestamp).toLocaleString()}\n` +
                            `è¿™å°†æ¸…ç©ºå½“å‰å¯¹è¯ã€‚`
                        );
                        
                        if (confirmed && agent) {
                            // æ¸…ç©ºå½“å‰çŠ¶æ€
                            agent.clearState();
                            
                            // æ¢å¤å¯¼å…¥çš„çŠ¶æ€
                            importData.events.forEach(event => {
                                switch (event.type) {
                                    case 'user_message':
                                        agent.addUserMessage(event.data.content);
                                        break;
                                    case 'agent_message':
                                        agent.addAgentMessage(event.data.content);
                                        break;
                                    case 'tool_result':
                                        agent.addToolResult(event.data.results);
                                        break;
                                }
                            });
                            
                            // æ¢å¤èŠå¤©å†å²æ˜¾ç¤º
                            restoreChatHistory(importData.events);
                            
                            // ä¿å­˜åˆ°localStorage
                            saveAgentState();
                            
                            // æ›´æ–°æ˜¾ç¤º
                            updateStats();
                            updateStates();
                            
                            console.log('ğŸ“¥ çŠ¶æ€å·²ä»æ–‡ä»¶å¯¼å…¥');
                            alert('çŠ¶æ€å¯¼å…¥æˆåŠŸï¼');
                        }
                    } else {
                        alert('æ— æ•ˆçš„çŠ¶æ€æ–‡ä»¶æ ¼å¼');
                    }
                } catch (error) {
                    console.error('å¯¼å…¥çŠ¶æ€å¤±è´¥:', error);
                    alert('å¯¼å…¥å¤±è´¥: ' + error.message);
                }
            };
            
            input.click();
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        sendButton.addEventListener('click', sendMessage);
        clearButton.addEventListener('click', clearChat);
        showStatsButton.addEventListener('click', updateStats);
        refreshStatesButton.addEventListener('click', updateStates);
        toggleStatesViewButton.addEventListener('click', toggleStatesView);
        exportStatesButton.addEventListener('click', exportStates);
        importStatesButton.addEventListener('click', importStates);
        
        // æ·»åŠ é…ç½®å¤´éƒ¨ç‚¹å‡»äº‹ä»¶
        document.getElementById('configHeader').addEventListener('click', toggleConfig);

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // æ¨¡å‹æˆ–é…ç½®æ”¹å˜æ—¶é‡æ–°åˆ›å»ºLLMå®¢æˆ·ç«¯
        document.getElementById('model').addEventListener('change', () => {
            if (llmClient) {
                createLLMClient();
                console.log('ğŸ”„ LLM client updated');
            }
        });
        
        document.getElementById('userToken').addEventListener('change', () => {
            if (llmClient) {
                createLLMClient();
                console.log('ğŸ”„ LLM client updated');
            }
        });

        // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é…ç½®é¢æ¿çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            // é»˜è®¤æ”¶èµ·é…ç½®é¢æ¿
            const panel = document.getElementById('configPanel');
            const toggle = document.getElementById('configToggle');
            if (panel && toggle) {
                panel.classList.add('collapsed');
                toggle.classList.add('rotated');
            }
            
            showInitialStatus();
            initializeSystem();
        });
        
        // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
        window.addEventListener('beforeunload', () => {
            saveAgentState();
        });

        // åˆå§‹åŒ–ç»Ÿè®¡æ˜¾ç¤º
        updateStats();
        updateStates();

        // DOM å…ƒç´  - æ·»åŠ è®°å¿†ç›¸å…³å…ƒç´ 
        const showMemoryStatsButton = document.getElementById('showMemoryStats');
        const clearMemoriesButton = document.getElementById('clearMemories');
        const memorySection = document.getElementById('memorySection');
        const memoryContainer = document.getElementById('memoryContainer');
        const refreshMemoryButton = document.getElementById('refreshMemory');
        const toggleMemoryViewButton = document.getElementById('toggleMemoryView');
        const exportMemoryButton = document.getElementById('exportMemory');

        // æ˜¾ç¤º/éšè—è®°å¿†ç»Ÿè®¡
        function toggleMemoryStats() {
            if (memorySection.style.display === 'none') {
                memorySection.style.display = 'block';
                updateMemoryDisplay();
                showMemoryStatsButton.textContent = 'ğŸ§  éšè—è®°å¿†';
            } else {
                memorySection.style.display = 'none';
                showMemoryStatsButton.textContent = 'ğŸ§  è®°å¿†ç»Ÿè®¡';
            }
        }

        // æ›´æ–°è®°å¿†æ˜¾ç¤º
        async function updateMemoryDisplay() {
            const userId = 'default';
            
            try {
                // è·å–è®°å¿†æ•°æ®
                const memoryData = await getMemoryData(userId);
                
                if (memoryViewMode === 'raw') {
                    // åŸå§‹JSONè§†å›¾
                    memoryContainer.innerHTML = `
                        <div class="states-raw">
                            <pre><code>${JSON.stringify(memoryData, null, 2)}</code></pre>
                        </div>
                    `;
                } else {
                    // æ ¼å¼åŒ–è§†å›¾
                    memoryContainer.innerHTML = formatMemoryDisplay(memoryData);
                }
            } catch (error) {
                console.error('Update memory display failed:', error);
                memoryContainer.innerHTML = `<div class="error">è®°å¿†åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–è®°å¿†æ•°æ®
        async function getMemoryData(userId) {
            const STORAGE_PREFIX = 'memory_system_';
            const shortTermKey = `${STORAGE_PREFIX}short_term_${userId}`;
            const longTermKey = `${STORAGE_PREFIX}long_term_${userId}`;
            
            // è·å–çŸ­æœŸè®°å¿†
            let shortTermMemories = [];
            try {
                const shortTermData = localStorage.getItem(shortTermKey);
                shortTermMemories = shortTermData ? JSON.parse(shortTermData) : [];
            } catch (error) {
                console.error('Parse short-term memory failed:', error);
            }
            
            // è·å–é•¿æœŸè®°å¿†
            let longTermMemory = '';
            try {
                longTermMemory = localStorage.getItem(longTermKey) || '';
            } catch (error) {
                console.error('Get long-term memory failed:', error);
            }
            
            return {
                shortTerm: shortTermMemories,
                longTerm: longTermMemory,
                stats: {
                    shortTermCount: shortTermMemories.length,
                    longTermLength: longTermMemory.length,
                    totalSize: (JSON.stringify(shortTermMemories).length + longTermMemory.length)
                }
            };
        }

        // æ ¼å¼åŒ–è®°å¿†æ˜¾ç¤º
        function formatMemoryDisplay(memoryData) {
            const { shortTerm, longTerm, stats } = memoryData;
            
            let html = `
                <div class="states-formatted">
                    <div class="memory-stats">
                        <div class="stat-card">
                            <div class="stat-title">çŸ­æœŸè®°å¿†æ•°é‡</div>
                            <div class="stat-value">${stats.shortTermCount}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">é•¿æœŸè®°å¿†é•¿åº¦</div>
                            <div class="stat-value">${stats.longTermLength}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">æ€»å­˜å‚¨å¤§å°</div>
                            <div class="stat-value">${(stats.totalSize / 1024).toFixed(1)}KB</div>
                        </div>
                    </div>
            `;
            
            // çŸ­æœŸè®°å¿†æ˜¾ç¤º
            if (shortTerm.length > 0) {
                html += `
                    <div class="memory-section">
                        <h4>ğŸ“ çŸ­æœŸè®°å¿† (${shortTerm.length} æ¡)</h4>
                `;
                
                shortTerm.forEach((memory, index) => {
                    const timestamp = new Date(memory.timestamp).toLocaleString('zh-CN');
                    html += `
                        <div class="state-item">
                            <div class="state-header">
                                <span class="state-type">ğŸ’­ è®°å¿† #${index + 1}</span>
                                <span class="state-time">${timestamp}</span>
                            </div>
                            <div class="state-content">
                                <div class="message-content-state">${memory.content}</div>
                                <div class="memory-meta">
                                    <small>ID: ${memory.id} | HP: ${memory.hp}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="system-info">æš‚æ— çŸ­æœŸè®°å¿†</div>';
            }
            
            // é•¿æœŸè®°å¿†æ˜¾ç¤º
            if (longTerm.trim()) {
                html += `
                    <div class="memory-section">
                        <h4>ğŸ§  é•¿æœŸè®°å¿† (${longTerm.length} å­—ç¬¦)</h4>
                        <div class="state-item">
                            <div class="state-content">
                                <div class="long-term-memory">
                                    <pre>${longTerm}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += '<div class="system-info">æš‚æ— é•¿æœŸè®°å¿†</div>';
            }
            
            html += '</div>';
            return html;
        }

        // åˆ‡æ¢è®°å¿†è§†å›¾æ¨¡å¼
        function toggleMemoryView() {
            memoryViewMode = memoryViewMode === 'formatted' ? 'raw' : 'formatted';
            toggleMemoryViewButton.textContent = memoryViewMode === 'formatted' ? 'ğŸ‘ï¸ åˆ‡æ¢åˆ°åŸå§‹è§†å›¾' : 'ğŸ‘ï¸ åˆ‡æ¢åˆ°æ ¼å¼åŒ–è§†å›¾';
            updateMemoryDisplay();
        }

        // æ¸…ç©ºè®°å¿†
        async function clearMemories() {
            const confirmed = confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
            if (confirmed) {
                try {
                    const userId = 'default';
                    const STORAGE_PREFIX = 'memory_system_';
                    const shortTermKey = `${STORAGE_PREFIX}short_term_${userId}`;
                    const longTermKey = `${STORAGE_PREFIX}long_term_${userId}`;
                    
                    localStorage.removeItem(shortTermKey);
                    localStorage.removeItem(longTermKey);
                    
                    console.log('è®°å¿†å·²æ¸…ç©º');
                    alert('è®°å¿†å·²æ¸…ç©ºï¼');
                    updateMemoryDisplay();
                } catch (error) {
                    console.error('æ¸…ç©ºè®°å¿†å¤±è´¥:', error);
                    alert('æ¸…ç©ºè®°å¿†å¤±è´¥: ' + error.message);
                }
            }
        }

        // å¯¼å‡ºè®°å¿†
        async function exportMemory() {
            try {
                const userId = 'default';
                const memoryData = await getMemoryData(userId);
                
                const exportData = {
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    version: '1.0',
                    ...memoryData
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `memory-export-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('ğŸ“¤ è®°å¿†å·²å¯¼å‡ºåˆ°æ–‡ä»¶');
            } catch (error) {
                console.error('å¯¼å‡ºè®°å¿†å¤±è´¥:', error);
                alert('å¯¼å‡ºè®°å¿†å¤±è´¥: ' + error.message);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨ - æ·»åŠ è®°å¿†ç›¸å…³äº‹ä»¶
        showMemoryStatsButton.addEventListener('click', toggleMemoryStats);
        clearMemoriesButton.addEventListener('click', clearMemories);
        refreshMemoryButton.addEventListener('click', updateMemoryDisplay);
        toggleMemoryViewButton.addEventListener('click', toggleMemoryView);
        exportMemoryButton.addEventListener('click', exportMemory);
    </script>
</body>
</html> 